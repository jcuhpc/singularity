#!/bin/bash
# Creation of environment-modules files for an pptainer

# Software sites metadata file locaiton.
META=/sw/apptainer/metadata/swsites

# Directory under which environment module files will be placed.
MDIR=/sw/modules/$1

# Directory housing singularity image files.
CDIR=/sw/containers

if [ $# -lt 2 ] ; then
    echo "Syntax:  emfiles <name> <vers> [-p] [-R]"
    echo "	-p = create aliases for python use"
    echo "	-R = create aliases for R use"
    echo "This script will create environment-modules files associated"
    echo "with the apptainer file $CDIR/<name>-<vers>.sif"
    exit 1
fi

S=$1
V=$2
shift
shift

##### MODIFICATIONS UNLIKELY TO BE REQUIRED IN THIS SECTION #####
pushd $CDIR
mkdir -p $MDIR
SITE=`grep ^$S\  $META | awk '{print $2}'`
[[ "$SITE" = "" ]]   &&   echo "WARNING: $META file does not contain information for $S!"

printf "# Common modulefile for HPC software\n"   >$MDIR/swinfo
printf "set sw_name $S\nset sw_site \"$SITE\"\n" >>$MDIR/swinfo

printf "#%%Module\nset sw_vers $V\n"		 >/tmp/$V
printf "set moduledir [file dirname \$ModulesCurrentModulefile]\n" >>/tmp/$V
printf "source \$moduledir/swinfo\n"		>>/tmp/$V
printf "source \$moduledir/../common\n"		>>/tmp/$V
printf "source \$moduledir/../container\n"	>>/tmp/$V
printf "source \$moduledir/aliases\n"		>>/tmp/$V
install -m 664 -o sci-wam -g hpc-admins /tmp/$V $MDIR/

# Identify aliases that will be made available (automatically).
singularity run $S-$V.sif test -d /opt/conda
if [ $? -eq 1 ] ; then
    # Use dpkg to discover most likely candidates
    CMDS=`singularity run $S-$V.sif dpkg -L $S 2>/dev/null | grep \/usr\/bin\/ | sed -e 's@/usr/bin/@@'`
    if [ "$CMDS" = "" ] ; then
	# Look for executables under /opt
	CMDS=`singularity run $S-$V.sif find /opt -type f -executable | awk -F\/ '{print $NF}'`
	if [ "$CMDS" = "" ] ; then
	    # Assumes software manually installed under /usr/local inside container
      CMDS=`singularity run $S-$V.sif find /usr/local -type f -executable | awk -F\/ '{print $NF}'`
    fi
  fi
else
  # Miniconda (conda-container script) based container installation
  CMDS=`singularity run $S-$V.sif find /opt/conda/pkgs -maxdepth 1 -name $S-$V\* -type d`
  CMDS=`singularity run $S-$V.sif ls $CMDS/bin 2>/dev/null`
fi

printf "# SIF is defined in ../container\n" >/tmp/aliases
if   [ "$1" = "-p" -o "$2" = "-p" ] ; then
    printf "set-alias python\t\"singularity run \$SIF python\"\n" >>/tmp/aliases
    printf "set-alias python3\t\"singularity run \$SIF python3\"\n" >>/tmp/aliases
elif [ "$1" = "-R" -o "$2" = "-R" ] ; then
    printf "set-alias R\t\"singularity run \$SIF R\"\n" >>/tmp/aliases
    printf "set-alias Rscript\t\"singularity run \$SIF Rscript\"\n" >>/tmp/aliases
fi
for X in $CMDS ; do
  printf "set-alias $X\t\"singularity run \$SIF $X\"\n" >>/tmp/aliases
done

if [ ! -f $MDIR/aliases ] ; then
    install -m 664 -o sci-wam -g hpc-admins /tmp/aliases $MDIR/
else
    MSG=`diff $MDIR/aliases /tmp/aliases`
    if [ $? -eq 1 ] ; then
        echo ""
	echo "Alias mismatch found!  Suggested aliases file is:"
        cat /tmp/aliases
        echo ""
    fi
fi
rm -f /tmp/aliases /tmp/$V

popd
