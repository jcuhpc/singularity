#!/bin/bash
if [ $# -ne 2 ] ; then
  echo "Syntax:  emfiles <sw_name> <sw_vers>"
  exit 1
fi
#####  MODIFICATIONS LIKELY TO BE REQUIRED IN THIS SECTION  #####

# Software sites metadata file locaiton.
META=/sw/BUILD/metadata/swsites

# Directory under which environment module files will be placed.
MDIR=/sw/modules/$1

# Directory housing singularity image files.
CDIR=/sw/containers

##### MODIFICATIONS UNLIKELY TO BE REQUIRED IN THIS SECTION #####
pushd $CDIR
mkdir -p $MDIR
SITE=`grep ^$1\  $META | awk '{print $2}'`
[[ "$SITE" = "" ]]   &&   echo "WARNING: $META file does not contain information for $1!"

if [ ! -f $MDIR/swinfo ] ; then
  printf "# Common modulefile for HPC software\n"   >$MDIR/swinfo
  printf "set sw_name $1\nset sw_site \"$SITE\"\n" >>$MDIR/swinfo
fi

printf "#%%Module\nset sw_vers $2\n"		 >/tmp/$1-$2
printf "set moduledir [file dirname \$ModulesCurrentModulefile]\n" >>/tmp/$1-$2
printf "source \$moduledir/swinfo\n"		>>/tmp/$1-$2
printf "source \$moduledir/../common\n"		>>/tmp/$1-$2
printf "source \$moduledir/../container\n"	>>/tmp/$1-$2
printf "source \$moduledir/aliases\n"		>>/tmp/$1-$2
install -m 664-o sci-wam -g hpc-admins /tmp/$1-$2 $MDIR/$2

# Identify aliases that will be made available (automatically).
singularity run $1-$2.sif test -d /opt/conda
if [ $? -eq 1 ] ; then
  # Ubuntu (u??04-container scripts) based container installation
  CMDS=`singularity run $1-$2.sif dpkg -L $1 2>/dev/null | grep \/usr\/bin\/ | sed -e 's@/usr/bin/@@'`
  if [ "$CMDS" = "" ] ; then
    # Assumes software manually installed under /opt inside containear
    CMDS=`singularity run $1-$2.sif find /opt -type f -executable | awk -F\/ '{print $NF}'`
    if [ "$CMDS" = "" ] ; then
      # Assumes software manually installed under /usr/local inside container
      CMDS=`singularity run $1-$2.sif find /usr/local -type f -executable | awk -F\/ '{print $NF}'`
    fi
  fi
else
  # Miniconda (conda-container script) based container installation
  CMDS=`singularity run $1-$2.sif find /opt/conda/pkgs -maxdepth 1 -name $1-$2\* -type d`
  CMDS=`singularity run $1-$2.sif ls $CMDS/bin`
fi

printf "# SIF is defined in ../container\n" >/tmp/aliases
for X in $CMDS ; do
  printf "set-alias $X\t\"singularity run \$SIF $X\"\n" >>/tmp/aliases
done

if [ ! -f $MDIR/aliases ] ; then
    install -m 664-o sci-wam -g hpc-admins /tmp/aliases $MDIR/
else
    MSG=`diff $MDIR/aliases /tmp/aliases`
    if [ $? -eq 1 ] ; then
        echo ""
	echo "Alias mismatch found!  Suggested aliases file is:"
        cat /tmp/aliases
        echo ""
    fi
fi
rm -f /tmp/aliases

popd
