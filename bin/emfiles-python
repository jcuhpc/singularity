#!/bin/bash
if [ $# -ne 2 ] ; then
  echo "Syntax:  emfiles-python <sw_name> <sw_vers>"
  exit 1
fi
#####  MODIFICATIONS LIKELY TO BE REQUIRED IN THIS SECTION  #####

# Software sites metadata file locaiton.
META=/sw/apptainer/metadata/swsites

# Directory under which environment module files will be placed.
MDIR=/sw/modules/$1

# Directory housing singularity image files.
CDIR=/sw/containers

##### MODIFICATIONS UNLIKELY TO BE REQUIRED IN THIS SECTION #####
pushd $CDIR
mkdir -p $MDIR
SITE=`grep ^$1\  $META | awk '{print $2}'`
[[ "$SITE" = "" ]]   &&   echo "WARNING: $META file does not contain information for $1!"

printf "# Common modulefile for HPC software\n"   >$MDIR/swinfo
printf "set sw_name $1\nset sw_site \"$SITE\"\n" >>$MDIR/swinfo

printf "#%%Module\nset sw_vers $2\n"		 >/tmp/$2
printf "set moduledir [file dirname \$ModulesCurrentModulefile]\n" >>/tmp/$2
printf "source \$moduledir/swinfo\n"		>>/tmp/$2
printf "source \$moduledir/../common\n"		>>/tmp/$2
printf "source \$moduledir/../container\n"	>>/tmp/$2
printf "source \$moduledir/aliases\n"		>>/tmp/$2
install -m 664 -o sci-wam -g hpc-admins /tmp/$2 $MDIR/

printf "# SIF is defined in ../container\n" >/tmp/aliases
printf "set-alias python\t\"singularity run \$SIF python\"\n"   >>/tmp/aliases
printf "set-alias python3\t\"singularity run \$SIF python3\"\n" >>/tmp/aliases

if [ ! -f $MDIR/aliases ] ; then
    install -m 664 -o sci-wam -g hpc-admins /tmp/aliases $MDIR/
else
    MSG=`diff $MDIR/aliases /tmp/aliases`
    if [ $? -eq 1 ] ; then
        echo ""
	echo "Alias mismatch found!  Suggested aliases file is:"
        cat /tmp/aliases
        echo ""
    fi
fi
rm -f /tmp/aliases /tmp/$2

popd
