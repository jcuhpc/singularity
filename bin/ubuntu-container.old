#!/bin/bash
# Creation of a Ubuntu based apptainer

if [ $# -eq 0 ] ; then
    # Brief syntax message.
    echo "Syntax:  ubuntu-container <pkg0> [-d <dist>] [-n <name>] [-v <vers>] [-x <pkg1> [-x <pkg2>] ...]"
    echo "	<pkg0> = Primary software package"
    echo "	<dist> = Ubuntu version used (def: 22.04)"
    echo "	<name> = Base name used for apptainer image file"
    echo "	<vers> = Version used in apptainer image file name"
    echo "	<pkg#> = Extra software packages required to be installed"
    echo ""
    echo "Options will not be required for most apptainer creations."
    echo "Packages <pkg0> depends upon will be installed automatically."
    echo ""
    exit 1
fi

# Process arguments & options.
N=$1
S=$1
X=""
shift
D="22.04"
while [[ $# -gt 0 ]] ; do
    opt="$1"
    case $opt in
	-d)
	    D="$2"
	    shift
	    shift
	    ;;
	-n)
	    N="$2"
	    shift
	    shift
	    ;;
	-v)
	    C="$2"
	    shift
	    shift
	    ;;
	-x)
	    X="$X $2"
	    shift
	    shift
	    ;;
	*)
	    echo "Option $1 unknown, ignoring!"
	    shift
	    ;;
    esac
done

# Base of apptainers creation structure.
BASE=`which $0 | awk -F'/bin' '{print $(NF-1)}'`

# Directory housing apptainer definition file templates.
META="$BASE/metadata/ubuntu"

# Retrieve pre-configured variables: $DEST & $TEMP
source $BASE/config

# Auto-detect version of primary software package
[[ "$D" = "22.10" ]]   &&   U="kinetic"
[[ "$D" = "22.04" ]]   &&   U="jammy"
[[ "$D" = "21.04" ]]   &&   U="hirsute"
[[ "$D" = "20.04" ]]   &&   U="focal"
[[ "$D" = "18.04" ]]   &&   U="bionic"
V=`curl https://packages.ubuntu.com/$U/$S 2>/dev/null | awk -F[\(\)] '/Package:/{print $2}' | awk -F[-+] '{print $1}'`
[[ "$C" = "" ]]   &&   C=$V

# Create apptainer definition file
F="$META/ubuntu-$D-base.template"
[[ ! -f $F ]]   &&   echo "ERROR: $F doesn't exist!"   &&   exit 1
cat $F | sed -e "s/SWNAME/$S $X/g" >$TEMP/$N.def

# Build & Install the apptainer
sudo singularity build $TEMP/$N-$C.sif $TEMP/$N.def
cp $TEMP/$N-$C.sif $DEST/
rm -f $TEMP/$N-$C.sif
